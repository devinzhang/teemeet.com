<?php
// $Id: devel.module,v 1.258.2.77 2010/08/13 16:46:59 weitzman Exp $
/*group_extensions_menu()
{
    
}*/
define('NODE_TYPE', 'group'); //节点类型

/*function group_extensions_form_alter(&$form, $form_state, $form_id)
{
    if($_GET['q'] == 'node/add/group') print_r($form_id);
}*/
//_form_group_node
function group_extensions_perm()
{
    return array('create group');
}

function group_extensions_menu()
{
    $items['group/create'] = array
    (
        'title' => 'Start a new group!',
        'description' => 'Create a group',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('group_create'),
        'access callback' => 'user_is_logged_in',
        'file' => 'group_form.inc',
    );
    
    $items['group/%/comments'] = array(
    	'title' => t('All Group Reviews'),
        'page callback' => 'group_extensions_comments_list',
        'page arguments' => array(1),                
        'access callback' =>true,
        'type' => MENU_CALLBACK, 
        'file' => 'group.comment.inc',
    );
    $items['groupextension/ajax/postcomment']=array(
		'title'=>t('Post Comment'),
		'page callback'=>'group_extensions_ajax_postcomment',
		'page arguments'=>null,
		'access callback'=>TRUE,
        'type' => MENU_CALLBACK,
        'file' => 'group.comment.inc',
	);
    
    $items['groupextension/allmembers/%']=array(
		'title'=>t('All Members'),
		'page callback'=>'group_extensions_all_group_members',
		'page arguments'=>array(2),
		'access callback'=>TRUE,
        'type' => MENU_LOCAL_TASK,        
	);
    $items['groupextension/allmembers/%/all']=array(
        'title'=>t('All Members'),
		'title callback' => 'group_extensions_allmembers_page_title',
        'title arguments' => array(2),    
        'type' => MENU_DEFAULT_LOCAL_TASK,           
	);
     $items['groupextension/allmembers/%/leadship']=array(
        'title'=>t('The Leadship Team'),
		'title callback' => 'group_extensions_leaship_page_title',
        'title arguments' => array(2),    
        'page callback'=>'group_extensions_all_leadship_members',
		'page arguments'=>array(2),
		'access callback'=>TRUE,
        'type' => MENU_LOCAL_TASK,           
	);
    
    
    return $items;    
}


/**
 * Implementation of hook_theme().
 *
 *
 */
function group_extensions_theme() {
  return array(
   'group_extensions_member' => array(	 // theme one member
      'arguments' => array(
            'member'=>null, 
            
        ),
	),
        
  );
}


/*function group_extensions_form_alter(&$form, $form_state, $form_id)
{ 
    if($form_id != FORMID) return;
} */

function group_extensions_nodeapi(&$node, $op, $teaser, $page) 
{
    if($node->type == NODE_TYPE and $node->status != 0 and $op == 'view') 
    {
        $node_timeStamp = dateToStamp($node->field_date_valuable[0][value]);
        if(time() > $node_timeStamp)
        {
            $node->status = 0;
            node_save($node);
        }
    }    
    //if($op == 'insert'){ print_r($node);die;}
}

/**
 * dateToStamp()
 * 输入形如 yyyy-mm-dd 的日期返回日期时间戳
 * @param string $date
 * @return void
 */
function dateToStamp($date = '0000-00-00 ignore')
{
    $day = (int)substr($date, 8, 2);
    $month = (int)substr($date, 5, 2);
    $year = (int)substr($date, 0, 4);
    return mktime(0, 0, 0, $month, $day, $year);
}



/* Get all one user's comment for a group node
 * @param $gid, group node nid
 * @param $uid, the user uid
 * return, if there is a value, return , otherwise, 0
 */
function group_extensions_get_my_group_review($gid, $uid){
	$output = '';

		// Pre-process variables.
		$nid = $gid;
	
		$query = 'SELECT c.cid as cid, c.pid, c.nid, c.subject, c.comment, c.format, c.timestamp, c.name, c.mail, c.homepage, u.uid, u.name AS registered_name, u.signature, u.signature_format, u.picture, u.data, c.thread, c.status FROM {comments} c INNER JOIN {users} u ON c.uid = u.uid WHERE c.nid = %d and c.uid=%d';
        
		// Start a form, for use with comment control.
		$result = db_query($query,$gid, $uid);

		$num_rows = FALSE;
		
		global $base_path;
		$a= null; 
		while ($comment = db_fetch_object($result)) {
			$num_rows = TRUE;
            $a = $comment; 
		}

		if($num_rows) {           
			return $a; 
		} else {
        echo 'false';
			return FALSE;
		}	
}

/* menu call back, show the group members
** @param $gid, the group nid
*/
function group_extensions_all_group_members($nid) {
    $output = '';
       
    global $user; 
    $arg = 0;
     if(isset($GLOBALS['current_group'])){
        $current_group = $GLOBALS['current_group'];
        $arg = $current_group->nid;         
     }
     $output .= '<ul class="D_actions hasIcons">
                <li class="canDo">
                    <a class="sprite sprite_action user_green_icon" href="'.url($current_group->path.'/member/'.$user->uid.'/ingroup/'.$current_group->nid).'">View your profile</a>
                </li>
                <li class="canDo">
                <a class="sprite sprite_action email_edit_icon" href="">Edit communication settings</a>
                </li>
                </ul>';
      $output.=_group_extensions_members_tabmenu($arg);
     $output .= group_extensions_all_show_members($arg); 
    return $output; 
}

/* output the tabed menu
**
*/

function _group_extensions_members_tabmenu($gid){
    $cnt = _group_extensions_get_all_members($gid, TRUE);
    $output .='<ul class="D_tabs connected">';
    $output .='<li class="select">';
     $output .='<a href="">'.t('All members ').'<span class="D_count">('. $cnt.')</span></a>';
    $output .='</li>';
     $output .='<li>';
     $output .='<a href="">'.t('The Leadership Team').'<span class="D_count">(1)</span></a>';
    $output .='</li>';
    $output .= '</ul>';
    return $output; 
}

function group_extensions_all_show_members($gid) {
     $output = '';
     $members = _group_extensions_get_all_members($gid);
     
     $output .= '<ul id="list_of_members" class="memlist dues">';    
     
     foreach($members as $user) {
        $uid = $user->uid;
        $output .= '<li id="member_'.$user->uid.'">'.theme('group_extensions_member',$user ).'</li>';  
     }
     $output .= '</ul>';
    return $output;  
}
/* get all the members in array form, without theme
** @param $gid , group nid
** @param $count, if only return a member number, true only number
*/
function _group_extensions_get_all_members($gid, $count=false){
    $view_name = 'og_members_faces';    
    $result = views_get_view_result($view_name,'Page', $gid);  
    if($count){
        return count($result);
    }else{
        return $result; 
    }
}
function group_extensions_allmembers_page_title($gid){
    $cnt = _group_extensions_get_all_members($gid, TRUE);
    return t('All Members (@cnt)',array('@cnt'=>$cnt));
}

function group_extensions_leaship_page_title($gid){
 //   $cnt = _group_extensions_get_all_members($gid, TRUE);
        $cnt = 1; 
    return t('The Leadship Team (@cnt)',array('@cnt'=>$cnt));
}
/* menu callback */
function group_extensions_all_leadship_members($gid){
    $output ='';
    $output .='Under construction';
    return $output; 
}


/* menu callback for the theme
** @param , the members list
**Array
(
    [0] => stdClass Object
        (
            [uid] => 62
            [users_picture] => sites/default/files/upload_element/13.jpg
            [users_name] => devin
            [users_mail] => devin@a.com
            [og_uid_is_admin] => 1
        )

)
*/
function theme_group_extensions_member($member){
     $output = '';
     $user = user_load($member->uid);
    
     $current_group = $GLOBALS['current_group'];
      $member_profile = $user->og_groups[$current_group->nid]['member_profile'];
     global $base_url; 
     $output .= '<div id="image_'.$member->uid.'" class="profphoto">';
     $output .= '<a href="'.url( $current_group->path.'/member/'.$member->uid.'/ingroup/'.$current_group->nid).'"><img width="80px" height= "80" class="memPhoto" alt="" src="'.$base_url.'/'.$user->picture.'"></a>';
     $output .= '</div>';
     $output .= '<div class="memberItem clearfix">
        <div class="memberActions canOnlyEmail D_dropdown">
        <a title="Send an Email" class="cog emailcog" href="http://www.meetup.com/Beijing-Soccer-Lovers/message/?recipientId=20252341"><span></span></a>
        </div>
<div class="memberInfo hasOnlyEmail">
<div id="memberInfo_20252341" class="D_title">';
$output .= '<a class="memName" href="'.url( $current_group->path.'/member/'.$member->uid.'/ingroup/'.$current_group->nid).'">'.$user->name.'</a>';
$output .= '<span id="role_20252341" class="memRole">

</span>

<ul class="D_less memStats">';
$output .= '<li><span class="bold">Joined</span>: '.format_date($user->created).'</li>';

$output .= '<li><span class="bold">Last visited</span>:'.format_date($user->login,'small').'</li>';
$output .= '</ul><p class="D_less">"'.$member_profile->introduction.'"</p></div></div></div>';     
     return $output; 
}
